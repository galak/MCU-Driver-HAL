# CMake target porting

See below instructions to add support for boards that implement MCU-Driver-HAL to build with CMake.

Important variables provided for MCU-Driver-HAL boards:

* `MBED_TOOLCHAIN`: Selects the toolchain to use to build the artefacts. It an be set to `"ARM"` or `"GCC_ARM"` for the Arm Compiler toolchain or the GNU Arm Embedded Toolchain respectively.
* `MBED_TARGET`: Sets the name of the hardware platform to build the artefacts for. 
* `MBED_CPU_CORE`: Determines the ARM MCU core the hardware platform MCU is based on. This is used to select the appropriate toolchain flags by selecting [the correct CMake module](../../../tools/cmake/cores/).
* `MBED_C_LIB`: Selects the C standard library size to use, it can be set to `"small"` or `"std"`. If `"std"` is chosen the standard C library is used for the selected toolchain. If `"small"` is chosen, MicroLib or newlib-nano are selected for `"ARM"` or `"GCC_ARM"` respectively.
* `MBED_PRINTF_LIB`: Selects the library to use for printing to a stream. It can be set to `"std"` or `"minimal-printf"` where the former is the standard library and the former is an optimised version of the library available regardless of the toolchain selected.
* `MBED_OUTPUT_EXT`: Selects whether to generate a binary file and/or an Intel HEX file. It can be set to `"bin"`, `"hex"`, or again `""` for both to be generated.
* `MBED_TARGET_SUPPORTED_C_LIBS`: Specifies which C libraries are supported by the hardware platform (`std` and/or `small`).
* `MBED_TARGET_SUPPORTED_APPLICATION_PROFILES`: Specifies if the hardware platform can be built with RTOS support and/or bare-metal.
* `MBED_TARGET_LABELS`: Defines labels used to select which features are supported by the hardware platform.
* `MBED_TARGET_DEFINITIONS`: Defines C languages macros for the pre-processor to include C statements to consider for the build.
* `MBED_CONFIG_DEFINITIONS`: Defines C languages macros for the pre-processor to have appropriate values to use in source code.

Note: All the CMake variables above are generated by `mbed-tools`.

## Board CMake input file structure
Every board CMake targets should be prefixed with `mbed-`. 
The content of teh `MBED_TARGET` CMake variable is name-mangled by MCU-Driver-HAL to identify the library CMake target for the hardware platform. For example; if it is set to `"XXX_YYY"`, MCU-Driver-HAL will attempt to find a hardware platform library CMake target named `mbed-xxx-yyy` to link the executable CMake target with.
MCU-Driver-HAL expects to find the hardware platform CMake target defined in partner SDKs and only links to it, all its dependencies are resolved in partner SDKs.


### Linker script file

A CMake function `mbed_set_linker_script` must be invoked for each linker file. The linker file must be listed with its absolute path, this is achieved by adding the sub-path obtained by the CMake variable `${CMAKE_CURRENT_SOURCE_DIR}`.  
E.g

```cmake
add_library(mbed-stm32l475xg INTERFACE)

if(${MBED_TOOLCHAIN} STREQUAL "GCC_ARM")
    set(STARTUP_FILE TOOLCHAIN_GCC_ARM/startup_stm32l475xx.S)
    set(LINKER_FILE TOOLCHAIN_GCC_ARM/stm32l475xg.ld)
elseif(${MBED_TOOLCHAIN} STREQUAL "ARM")
    set(STARTUP_FILE TOOLCHAIN_ARM/startup_stm32l475xx.S)
    set(LINKER_FILE TOOLCHAIN_ARM/stm32l475xg.sct)
endif()

...

mbed_set_linker_script(mbed-stm32l475xg ${CMAKE_CURRENT_SOURCE_DIR}/${LINKER_FILE})
```

## Developer's guide

We are using CMake to allow the generation of build systems instructions to build MCU-Driver-HAL as a library.

This is still in development, if you find a bug, please report it or raise a pull request as contributions are welcome!

MCU-Driver-HAL is built as a single library. Application project executables can be linked with the `mbed-os` library.

### Supported toolchains

Arm Compiler 6 and GNU Arm Embedded toolchains are supported.

### Examples

The examples can be built with CMake, see [this](../../examples/README.md) for more information.

### Known issues

- Ninja: ARMClang6 response files require unix paths on Windows. Reference: https://gitlab.kitware.com/cmake/cmake/-/issues/21093. We disabled response files for Ninja on Windows until CMake is fixed.

## How to build an application

Prerequisities:
- CMake >=3.19.0
- mbed-tools >=7.16.0
- Python modules defined in [`tools/cmake/requirements.txt`](./requirements.txt)

Refer to [the examples guide](../../examples/README.md) for build instructions.

`CMAKE_BUILD_TYPE` can overridden with specific values: `Develop` (default value), `Release` and `Debug`.

## How to build a greentea test

This information will be provided in the future.

## Naming convention
We require the board CMake target names to follow the format `mbed-xxx-yyy-zzz` which is:
- must have `mbed-` prefix
- all characters are lower case
- words separated by hyphens
